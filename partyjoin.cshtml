@{
    Layout = "~/_SiteLayout.cshtml";
    var db = Database.Open("MySQLDB");
    var characterid = Request.QueryString["characterid"];

    Validation.RequireField("partyname", "Party name is a required field.");
    Validation.RequireField("partypassword", "Party password is a required field.");

    var add_error = false;
    //var leader = 0;


    if (IsPost)
    {

        if (Validation.IsValid())
        {
            var partyname = Request.Form["partyname"];
            var partypassword = Request.Form["partypassword"];

            var check_members_query = "SELECT * FROM party WHERE partyname ='" + partyname + "'";

            var empty_slot1 = "";
            var empty_slot2 = "";

            //Checks the party for empty slots (max 10 including leader)
            foreach (var row in db.Query(check_members_query))  //to lazy for string concatenation
            {
                if (row.m2 == null) //m1 and c1 are for dm
                {
                    empty_slot1 = "m2";
                    empty_slot2 = "c2";
                }
                else if (row.m3 == null)
                {
                    empty_slot1 = "m3";
                    empty_slot2 = "c3";
                }
                else if (row.m4 == null)
                {
                    empty_slot1 = "m4";
                    empty_slot2 = "c4";
                }
                else if (row.m5 == null)
                {
                    empty_slot1 = "m5";
                    empty_slot2 = "c5";
                }
                else if (row.m6 == null)
                {
                    empty_slot1 = "m6";
                    empty_slot2 = "c6";
                }
                else if (row.m7 == null)
                {
                    empty_slot1 = "m7";
                    empty_slot2 = "c7";
                }
                else if (row.m8 == null)
                {
                    empty_slot1 = "m8";
                    empty_slot2 = "c8";
                }
                else if (row.m9 == null)
                {
                    empty_slot1 = "m9";
                    empty_slot2 = "c9";
                }
                else if (row.m10 == null)
                {
                    empty_slot1 = "m10";
                    empty_slot2 = "c10";
                }
                else if (row.m11 == null)
                {
                    empty_slot1 = "m11";
                    empty_slot2 = "c11";
                }
                else
                {
                    add_error = true;
                }
            }

            //Adds a member to the party
            //var update_member_query = "UPDATE party SET m1=@0 WHERE partyname=@1";  THIS WORKS
            var update_member_query = "UPDATE party SET " + empty_slot1 + "=@0 WHERE partyname=@1"; //I have no clue why this works
            db.Execute(update_member_query, Session["UserID"], partyname);

            var update_character_query = "UPDATE party SET " + empty_slot2 + "=@0 WHERE partyname=@1";
            db.Execute(update_character_query, characterid, partyname);


            /*Changed due to changes in character and party tables
            //Gets partyid from database
            var partyid_query = "UPDATE party SET " + empty_slot + "=@0 WHERE partyname=@1";
            var partyid = db.QueryValue(partyid_query);

            //Updates partyid in character database for character
            var update_char_partyid = "UPDATE character SET partyid='" + partyid + "' WHERE characterid='" + characterid +"'";
            db.Query(update_char_partyid);
            */

            Response.Redirect(@Href("~/viewaccount.cshtml"));


        }
    }
}

<!DOCTYPE html>
<html>
<head>
    <title></title>
</head>
<body>
    <br />
    <br />
    <br />
    <div class="container">
        <form method="post" id="party_form">
            <div class="row">
                <div class="col-sm-8">
                    <div class="card mt-6">
                        <div class="card-header">
                            <h1>Join a Party</h1>
                            <h3>Use the Party Name and Party Password to join your friends.</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">                                
                                <div class="col-sm-2">
                                    <label for="partyid">Party Name:</label>
                                </div>
                                <div class="col-sm-6">
                                    <input type="text" class="form-control" placeholder="Party Name" id="partyname" name="partyname" value="" />
                                    @*Html.ValidationMessage("partyname")*@
                                </div>                                    
                            </div>
                            <br />
                            <div class="row">                                
                                <div class="col-sm-2">
                                    <label for="partypassword">Party Password:</label>
                                </div>
                                <div class="col-sm-6">
                                    <input type="text" class="form-control" placeholder="Party Password" id="partypassword" name="partypassword" value="" />
                                    @*Html.ValidationMessage("partypassword")*@
                                </div>                                    
                            </div>
                            <br />                            
                             @Html.ValidationSummary()                            
                            <br />
                            <br />
                            <div class="form-row">                                                                                                            
                                <div class="col-sm-7">
                                    <button type="button" class="btn-sm"><a style="color:black" href="partycreator.cshtml?characterid=@characterid" class="btn-sm" role="button">Create Party</a></button>
                                    @if (add_error)
                                    {
                                        <p style="color:red">ERROR: Cannot add member.</p>
                                    }                                    
                                </div>
                                <div class="col-sm-2">
                                    <button type="submit" class="btn-sm" action="partycreator.cshtml?characterid=@characterid">Submit</button>
                                </div>                                                                    
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            
            
        </form>
    </div>

</body>
</html>
